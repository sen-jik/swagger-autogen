<%
/**
 * API 클래스 생성 템플릿 (ky 버전)
 * - Swagger 태그별로 API 클래스 생성
 * - ky HTTP 클라이언트 기반
 * - 타입 안전성을 위한 TypeScript 지원
 * - 쿼리 파라미터 처리를 위한 유틸리티 메서드 포함
 */

const { utils, route, config, modelTypes } = it;
const { _, pascalCase, require } = utils;

// 모듈명을 PascalCase로 변환하여 클래스명 생성 (예: user -> UserApi)
const apiClassName = pascalCase(route.moduleName);

// 해당 모듈의 모든 API 엔드포인트
const routes = route.routes;

// 사용 가능한 DTO 타입들의 이름 목록
const dataContracts = _.map(modelTypes, "name");
%>

import { KyInstance, Options } from 'ky';

<%~ includeFile('../dto-import.ejs', { ...it }) %>

/**
 * <%= route.moduleName %> 모듈 API 클래스
 * - ky HTTP 클라이언트를 사용한 API 호출
 * - 타입 안전성을 위한 TypeScript 지원
 * - 쿼리 파라미터 자동 변환 기능
 */
export class <%= apiClassName %>Api {
private readonly instance: KyInstance;

/**
 * API 클래스 생성자
 * @param instance - ky HTTP 클라이언트 인스턴스
 */
constructor(instance: KyInstance) {
this.instance = instance;
}

/**
 * 객체를 URLSearchParams로 변환하는 정적 유틸리티 메서드
 * - 중첩된 객체나 배열을 쿼리 파라미터로 변환
 * - undefined 값은 자동으로 제외
 * - 배열 값은 여러 개의 동일한 키로 변환
 *
 * @param params - 쿼리 파라미터 객체
 * @returns URLSearchParams 인스턴스
 *
 * @example
 * createSearchParams({ name: 'john', tags: ['tag1', 'tag2'] })
 * // 결과: name=john&tags=tag1&tags=tag2
 */
static createSearchParams(
  params?: Record<string, string | number | boolean | Array<string | number | boolean>>
): URLSearchParams {
  const urlSearchParams = new URLSearchParams();

  if (params) {
    Object.entries(params)
      .filter(([, value]) => value !== undefined)
      .forEach(([key, value]) => {
        const values = Array.isArray(value) ? value : [value];
        values.forEach((v) => urlSearchParams.append(key, v.toString()));
      });
  }

  return urlSearchParams;
}

<% for (const route of routes) { %>
<%~ includeFile('./procedure-call.ejs', { ...it, route, apiClassName }) %>
<% } %>
}
